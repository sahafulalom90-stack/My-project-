<!DOCTYPE html>
<html>
<head>
    <title>Receiver - Listen Audio</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body style="text-align:center; padding-top: 50px; font-family: sans-serif;">
    <h2>Receiver (Admin Panel)</h2>
    <button id="start" style="padding:20px; font-size:20px; cursor:pointer;">START LISTENING</button>
    <p id="status">Status: Idle</p>
    <audio id="remoteAudio" autoplay controls></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGnVbP3NoTNtShKrYBCcb58ki1faBZeTI",
            authDomain: "audiomonitor-1bc41.firebaseapp.com",
            databaseURL: "https://audiomonitor-1bc41-default-rtdb.firebaseio.com",
            projectId: "audiomonitor-1bc41",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('calls/store');

        let pc;

        document.getElementById('start').onclick = async () => {
            document.getElementById('status').innerText = "Connecting... Wait for Answer";
            await db.set(null); 

            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

            pc.ontrack = e => {
                document.getElementById('remoteAudio').srcObject = e.streams[0];
                document.getElementById('status').innerText = "Streaming Live! (Listening...)";
            };

            pc.onicecandidate = e => {
                if (e.candidate) db.child('receiverIce').push(e.candidate.toJSON());
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            db.update({ offer: offer.sdp });

            db.child('answer').on('value', snapshot => {
                const answer = snapshot.val();
                if (answer && !pc.remoteDescription) {
                    pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answer }));
                }
            });

            db.child('senderIce').on('child_added', snapshot => {
                pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });
        };
    </script>
</body>
</html>