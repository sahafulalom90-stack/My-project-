<!DOCTYPE html>
<html>
<head>
    <title>Audio Monitor - Receiver</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: sans-serif; text-align: center; padding: 20px;">
    <h2>Store Audio Monitor (Live)</h2>
    <button id="listenBtn" style="padding: 20px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer;">START LISTENING</button>
    
    <div id="status" style="margin-top: 20px; font-weight: bold; color: blue;">Status: Ready</div>
    
    <audio id="remoteAudio" autoplay playsinline controls style="margin-top: 20px; width: 100%;"></audio>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBGnVbP3NoTNtShKrYBCcb58ki1faBZeTI",
          authDomain: "audiomonitor-1bc41.firebaseapp.com",
          databaseURL: "https://audiomonitor-1bc41-default-rtdb.firebaseio.com",
          projectId: "audiomonitor-1bc41",
          storageBucket: "audiomonitor-1bc41.firebasestorage.app",
          messagingSenderId: "75285264458",
          appId: "1:75285264458:web:1b4cf59f3397fbc8b0ceb3"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        // অডিও আসার সাথে সাথে প্লে করা
        pc.ontrack = (event) => {
            const audio = document.getElementById('remoteAudio');
            audio.srcObject = event.streams[0];
            document.getElementById('status').innerText = "Status: Streaming Live!";
            document.getElementById('status').style.color = "green";
        };

        // নিজের ICE Candidate পাঠানো
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                database.ref('calls/store/receiverIce').push(event.candidate.toJSON());
            }
        };

        // সেন্ডারের (দোকান) পাঠানো ICE Candidate গ্রহণ করা
        database.ref('calls/store/senderIce').on('child_added', (snapshot) => {
            const candidate = snapshot.val();
            if (candidate) {
                pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(e => console.error(e));
            }
        });

        document.getElementById('listenBtn').onclick = async () => {
            document.getElementById('status').innerText = "Status: Calling Store Phone...";
            
            // পুরোনো কানেকশন ডেটা মুছে ফেলা
            database.ref('calls/store').remove();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // অফার পাঠানো
            database.ref('calls/store').set({ offer: pc.localDescription.sdp });
        };

        // দোকানের ফোন থেকে Answer আসা মাত্রই সেট করা
        database.ref('calls/store/answer').on('value', async (snapshot) => {
            const answer = snapshot.val();
            if (answer && !pc.remoteDescription) {
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answer }));
            }
        });
    </script>
</body>
</html>
